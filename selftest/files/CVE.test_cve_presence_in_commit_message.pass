From b4d70931cc5fe4f661d81fbaaeaa87fbad5748ee Mon Sep 17 00:00:00 2001
From: Daniela Plascencia <daniela.plascencia@intel.com>
Date: Mon, 3 Apr 2017 11:27:19 -0500
Subject: [PATCH] glibc: CVE: CVE-2016-4429

glibc: adds CVE patch
CVE: CVE-2016-4429

---
 meta/recipes-core/glibc/glibc/CVE-2016-4429.patch | 86 +++++++++++++++++++++++
 meta/recipes-core/glibc/glibc_2.25.bb             |  1 +
 2 files changed, 87 insertions(+)
 create mode 100644 meta/recipes-core/glibc/glibc/CVE-2016-4429.patch

diff --git a/meta/recipes-core/glibc/glibc/CVE-2016-4429.patch b/meta/recipes-core/glibc/glibc/CVE-2016-4429.patch
new file mode 100644
index 0000000000..7d2980da2d
--- /dev/null
+++ b/meta/recipes-core/glibc/glibc/CVE-2016-4429.patch
@@ -0,0 +1,86 @@
+From bc779a1a5b3035133024b21e2f339fe4219fb11c Mon Sep 17 00:00:00 2001
+From: Florian Weimer <fweimer@redhat.com>
+Date: Mon, 23 May 2016 20:18:34 +0200
+Subject: [PATCH] CVE-2016-4429: sunrpc: Do not use alloca in clntudp_call [BZ
+ #20112]
+
+The call is technically in a loop, and under certain circumstances
+(which are quite difficult to reproduce in a test case), alloca
+can be invoked repeatedly during a single call to clntudp_call.
+As a result, the available stack space can be exhausted (even
+though individual alloca sizes are bounded implicitly by what
+can fit into a UDP packet, as a side effect of the earlier
+successful send operation).
+---
+ ChangeLog         |  7 +++++++
+ NEWS              |  4 ++++
+ sunrpc/clnt_udp.c | 10 +++++++++-
+ 3 files changed, 20 insertions(+), 1 deletion(-)
+
+Upstream-Status: Backport
+CVE: CVE-2016-4429
+Signed-of-by: Armin Kuster <akuster@mvista.com>
+
+Index: git/ChangeLog
+===================================================================
+--- git.orig/ChangeLog
++++ git/ChangeLog
+@@ -1,3 +1,9 @@
++2016-05-23  Florian Weimer  <fweimer@redhat.com>
++       CVE-2016-4429
++       [BZ #20112]
++       * sunrpc/clnt_udp.c (clntudp_call): Use malloc/free for the error
++       payload.
++
+ 2016-05-11  Florian Weimer  <fweimer@redhat.com>
+
+	Do not use mcheck in localedef.
+Index: git/NEWS
+===================================================================
+--- git.orig/NEWS
++++ git/NEWS
+@@ -48,6 +48,10 @@ Security related changes:
+   called with the GLOB_ALTDIRFUNC flag and encountered a long file name.
+   Reported by Alexander Cherepanov.  (CVE-2016-1234)
+
++* The Sun RPC UDP client could exhaust all available stack space when
++  flooded with crafted ICMP and UDP messages.  Reported by Aldy Hernandez'
++  alloca plugin for GCC.  (CVE-2016-4429)
++
+ The following bugs are resolved with this release:
+
+   [The release manager will add the list generated by
+Index: git/sunrpc/clnt_udp.c
+===================================================================
+--- git.orig/sunrpc/clnt_udp.c
++++ git/sunrpc/clnt_udp.c
+@@ -388,9 +388,15 @@ send_again:
+	  struct sock_extended_err *e;
+	  struct sockaddr_in err_addr;
+	  struct iovec iov;
+-	  char *cbuf = (char *) alloca (outlen + 256);
++	  char *cbuf = malloc (outlen + 256);
+	  int ret;
+
++	  if (cbuf == NULL)
++	    {
++	      cu->cu_error.re_errno = errno;
++	      return (cu->cu_error.re_status = RPC_CANTRECV);
++	    }
++
+	  iov.iov_base = cbuf + 256;
+	  iov.iov_len = outlen;
+	  msg.msg_name = (void *) &err_addr;
+@@ -415,10 +421,12 @@ send_again:
+		 cmsg = CMSG_NXTHDR (&msg, cmsg))
+	      if (cmsg->cmsg_level == SOL_IP && cmsg->cmsg_type == IP_RECVERR)
+		{
++		  free (cbuf);
+		  e = (struct sock_extended_err *) CMSG_DATA(cmsg);
+		  cu->cu_error.re_errno = e->ee_errno;
+		  return (cu->cu_error.re_status = RPC_CANTRECV);
+		}
++	  free (cbuf);
+	}
+ #endif
+       do
diff --git a/meta/recipes-core/glibc/glibc_2.25.bb b/meta/recipes-core/glibc/glibc_2.25.bb
index cf9c4f71b8..d735329e67 100644
--- a/meta/recipes-core/glibc/glibc_2.25.bb
+++ b/meta/recipes-core/glibc/glibc_2.25.bb
@@ -42,6 +42,7 @@ SRC_URI = "${GLIBC_GIT_URI};branch=${SRCBRANCH};name=glibc \
            file://0025-Define-DUMMY_LOCALE_T-if-not-defined.patch \
            file://0026-elf-dl-deps.c-Make-_dl_build_local_scope-breadth-fir.patch \
            file://0027-locale-fix-hard-coded-reference-to-gcc-E.patch \
+           file://CVE-2016-4429.patch \
 "

 NATIVESDKFIXES ?= ""
--
2.11.0
